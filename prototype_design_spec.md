# Leonardo Jr. 実証機用 QR初期設定・軽量防御設計定義書

## 文書情報

| 項目 | 内容 |
|------|------|
| 文書名 | Leonardo Jr. 実証機用 QR初期設定・軽量防御設計定義書 |
| 作成日 | 2026-02-20 |
| 作成者 | JAPAN Renaissance Partners |
| 策定方法 | 4AI合議結果を実証機スコープに最適化 |
| 目的 | ALSOK・自治体向けデモ機のQR初期設定機能と最低限の防御実装 |
| 効力範囲 | 実証機ファームウェア・クラウドAPI・Webセットアップ画面 |
| 量産機設計 | 防御設計定義書 v1.2 を別途保管（本文書のスコープ外） |

---

## 1. 実証機の位置づけ

### 1.1 目的

- ALSOK等セキュリティ企業への実機デモ
- 自治体への技術成立性証明
- LTE連携・通知・QR初期設定の概念実証

### 1.2 実証機で守るべきライン

- 設置現場でQRだけで初期設定が完了すること
- 検知イベントが正しくクラウドに到達すること
- 位置登録と紐付けが機能すること
- 「セキュリティ設計はここまで考えている」と商談で語れること

### 1.3 実証機では割り切ること

- 完全な盗難防御（盗まれたら困るではなく、盗まれてもサービス継続価値がある）
- Secure Boot / TPM / eMMCロック / JTAG封鎖
- デバイス鍵ペア生成・相互TLS
- ローカルストレージ暗号化
- チャレンジ・レスポンス認証（量産機v1.2で実装）

---

## 2. 個体識別

### 2.1 device_id生成方式

```
device_id = CPUシリアル下8桁 + "-" + 4桁乱数
例：LJ-A3F8B2C1-7294
```

### 2.2 CPUシリアル取得方法（Raspberry Pi）

```bash
cat /proc/cpuinfo | grep Serial | awk '{print $3}'
```

### 2.3 device_id生成タイミング

- 初回起動時に自動生成
- `/etc/leonardo/device_id` に保存
- 2回目以降は保存済みIDを使用

---

## 3. QRコード初期設定

### 3.1 QRコード内容

```
https://setup.leonardo-jr.jp/register?device_id={device_id}&fth={factory_token_hash}
```

| 項目 | 内容 |
|------|------|
| device_id | 個体識別ID |
| fth | factory_tokenのハッシュ値（factory_token自体は送信しない） |

**注意：** factory_token（平文）はQRにもURLにも含めない。URLはブラウザ履歴・リファラ・サーバログに残るため、ハッシュ値のみ送信し、サーバ側で再ハッシュ照合する。

### 3.2 factory_token生成方式

```python
import hashlib

factory_secret = "LEONARDO_JR_2026_SECRET"  # 実証機用固定シークレット

# Step 1: factory_token生成（デバイス内部のみ保持、外部に出さない）
factory_token = hashlib.sha256(f"{device_id}:{factory_secret}".encode()).hexdigest()[:16]

# Step 2: factory_token_hash生成（QRに埋め込む値）
factory_token_hash = hashlib.sha256(factory_token.encode()).hexdigest()[:16]

# サーバ側にはfactory_token_hashを保存
# QRにはfactory_token_hashのみ含める
# 照合：サーバが保存済みfactory_token_hashとQRパラメータのfthを比較
```

**注意：** 実証機では固定シークレットで十分。量産機ではワンタイムチャレンジ方式に移行（v1.2参照）。

### 3.3 QRコード生成タイミング

- device_id生成時にQRコードも同時生成
- PNG画像として `/etc/leonardo/qr_setup.png` に保存
- 本体ラベルに印刷（実証機は紙ラベル貼付）

### 3.4 登録フロー

```
1. ユーザーがスマホでQRコード読み取り
2. Webセットアップ画面が開く
3. factory_token_hash（fth）をサーバ側で照合
4. デバイスが未登録（devicesテーブルに未存在 or owner未設定）であることを確認
5. 未存在ならdevicesレコードをこの時点で作成（pre-register不要）
6. アカウント作成（メール + パスワード + 電話番号）
7. 利用規約承認
8. 通知先設定（LINE / メール）
9. 検知対象選択（熊 / 人 / 車両等）
10. スマホGPSで現在地取得
11. accuracy確認（50m以下推奨、100m超は警告）
12. 登録完了 → デバイスとユーザーを紐付け
```

**注意：** デバイスの事前登録（pre-register）は実施しない。QR登録時にdevicesレコードが存在しなければその場で作成する。起動時のLTE通信を減らし、圏外状態での初回起動にも対応。

### 3.5 初回登録ロック

- 一度登録されたdevice_idは、同じフローで別ユーザーが登録できない
- 再登録には既存所有者の認証が必要

---

## 4. アカウント設計（実証機用簡易版）

### 4.1 ユーザー情報

- メールアドレス（ログインID）
- パスワード（ハッシュ保存）
- 電話番号（通知用、実証機ではSMS認証は省略可）

### 4.2 認証方式

- メール + パスワードによるJWT認証
- SMS OTPは実証機では省略（量産機v1.2で追加）

---

## 5. 再登録フロー

### 5.1 再登録条件

- ログイン済みの既存所有者アカウントであること
- パスワード再入力必須

### 5.2 ゲリラ展開（再設置）時

1. 所有者がWebダッシュボードから「再設置」を選択
2. パスワード再入力
3. 新しい設置場所でスマホGPSから座標取得
4. 旧座標は履歴として保存（上書きしない）
5. 新座標がactive_flag = TRUEになる

### 5.3 所有者変更（実証機では想定外）

実証機フェーズでは所有者変更フローは実装しない。
デモ間の初期化はDB直接操作で対応。

---

## 6. 位置登録

### 6.1 データ構造

```
location_history
  ├─ device_id       （FK → devices）
  ├─ lat             （緯度）
  ├─ lon             （経度）
  ├─ accuracy        （精度値）
  ├─ registered_at   （登録日時 UTC）
  ├─ registered_by   （FK → users）
  ├─ active_flag     （現在有効フラグ）
  └─ ip_address      （登録時IP）
```

### 6.2 accuracy対応

| 条件 | 動作 |
|------|------|
| accuracy ≤ 50m | 登録OK |
| 50m < accuracy ≤ 100m | 警告表示、登録は可能 |
| accuracy > 100m | 警告表示、登録は可能（実証機では拒否しない） |

**注意：** 実証機では山間部テストがあるため、100m超でも登録を許可する。警告メッセージのみ表示。

### 6.3 active_flag制御

- 新規登録時に既存レコードをactive_flag = FALSEに更新
- 新規レコードをactive_flag = TRUEで挿入
- 同一トランザクション内で実行

---

## 7. 広域位置逸脱アラート（簡易版）

### 7.1 方式

デバイスのLTE通信時にサーバ側でIPジオロケーションを取得し、登録座標との大まかな距離を検証する。

### 7.2 判定ロジック

1. 発報時のIPアドレスからジオロケーション取得
2. 登録座標との距離を概算
3. 150km以上の乖離、または都道府県が異なる場合に所有者にアラート通知

**注意：** LTEのIPジオロケーションは数十km単位でズレることがあり、キャリアNATで遠隔地域のIPが割り当てられるケースもある。実証機では誤検知によるデモ中のトラブルを避けるため、閾値を150kmに設定。都道府県の変化も補助判定に使用。

### 7.3 実証機での扱い

- 通知のみ（自動ロックはしない）
- ダッシュボードに「位置逸脱検知」として表示
- 商談時に「量産機ではここから自動ロック・盗難対応フローに接続する」と説明
- 閾値は150km（LTE IPジオロケーションのズレを考慮し、デモ中の誤検知を防止）

---

## 8. LTE圏外時の動作

| 機能 | 状態 |
|------|------|
| AIローカル検知 | 動作 |
| JSONLログ保存 | 動作 |
| スピーカー警告音 | 動作 |
| サーバー発報 | 不可 |
| 圏内復帰時 | ログ一括アップロード |

---

## 9. 実装しないもの（量産機v1.2で対応）

| 機能 | 理由 |
|------|------|
| ワンタイムチャレンジ（登録時） | 固定トークン＋初回登録ロックで十分 |
| SMS OTP認証 | 実証機では省略 |
| デバイスオンラインチャレンジ・レスポンス | 実証機では不要 |
| device_tokensテーブル分離 | 単一トークンで十分 |
| challenge_type区別 | チャレンジ自体を実装しない |
| デバイス秘密鍵管理 | 量産機で対応 |
| 盗難自動ロック | 通知のみで十分 |
| 電源死因ログ | 後回し |
| ローカルストレージ暗号化 | 量産機で対応 |
| Secure Boot | 量産機で対応 |

---

## 10. 商談時の説明ポイント

実証機デモ時に、量産機設計v1.2の存在を以下のように説明する。

「現在の実証機はQR初期設定と基本的な位置検証を搭載しています。
量産機では以下の防御設計を追加予定です：」

- デバイス認証（チャレンジ・レスポンス方式）
- トークン履歴管理（不正通信追跡）
- 自動盗難検知・ロック
- ローカルストレージ暗号化
- 産業基盤ボード＋eMMC化によるハードウェア強化

---

以上
